version: 2.1
orbs:
  python: circleci/python@2
jobs:
  test-python:
    # Install dependencies and run tests
    docker:
      - image: cimg/python:3.12-node
    environment:
      ENDORCTL_VERSION: "latest"
      ENDOR_NAMESPACE: "arsalan-learn"
      GH_USER: "arsalanendor"
      CIRCLE_PROJECT_REPONAME: "python_poetry_test"
      #ENDOR_API_CREDENTIALS_KEY: "$ENDOR_API_CREDENTIALS_KEY"
      #ENDOR_API_CREDENTIALS_SECRET: "$ENDOR_API_CREDENTIALS_SECRET"
    steps:
      - checkout
      # - python/install-packages:
      #     pkg-manager: poetry
      # - run:
      #     name: Run tests
      #     command: poetry run pytest --junitxml=junit.xml || ((($? == 5)) && echo 'Did not find any tests to run.')     
      - run:
          name: "Endor Scan 102"
          command: |         
            sudo apt-get install jq
            #get pr info for this project and branch that triggered this workflow
            pr_response=$(curl --location --request GET "https://api.github.com/repos/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/pulls?head=$CIRCLE_PROJECT_USERNAME:$CIRCLE_BRANCH&state=open" -u $GH_USER:$GITHUB_ACCESS_TOKEN)
            
            if [ $(echo $pr_response | jq length) -eq 0 ]; then
              echo "No PR found to update"
            else
              echo "PR found"
              pr_comment_number=$(echo $pr_response | jq -r ".[].number")
              echo "PR#: $pr_comment_number"
              pr_reviews=$(curl --location --request GET "https://api.github.com/repos/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/pulls/$pr_comment_number/reviews" -u $GH_USER:$GITHUB_ACCESS_TOKEN)
              
              if [ $(echo $pr_reviews | jq length) -eq 0 ]; then
                echo "No reviews found for PR"
              else
                echo "PR is in review state"
                pr_review_state=$(echo $pr_reviews | jq -r ".[].state")
                if [ $pr_review_state == "APPROVED" ]; then
                  echo "PR is reviewed"
                  echo "Downloading endorctl and performing scan"
                  curl https://api.endorlabs.com/download/latest/endorctl_linux_amd64 -o endorctl
                  echo "$(curl -s https://api.endorlabs.com/sha/latest/endorctl_linux_amd64)  endorctl" | sha256sum -c;
                  if [ $? -ne 0 ]; then
                    echo "Integrity check failed";
                    exit 1;
                  fi
                  chmod +x ./endorctl
                  ./endorctl --version
                  ./endorctl scan --pr --dependencies --github-token="$GITHUB_ACCESS_TOKEN" --github-pr-id=$pr_comment_number --enable-pr-comments
                else
                  echo "PR is not reviewed"
                fi
              fi
            fi            
      - store_test_results:
          path: junit.xml
  deploy:
    # This is an example deploy job, not actually used by the workflow
    docker:
      - image: cimg/base:stable
    steps:
      # Replace this with steps to deploy to users
      - run:
          name: deploy
          command: '#e.g. ./deploy.sh'
      - run:
          name: found github actions config
          command: ':'
workflows:
  build-and-test:
    jobs:
      - test-python
    # - deploy:
    #     requires:
    #       - test-python
